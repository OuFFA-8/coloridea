<!-- Loading -->
@if (isLoading) {
  <div class="min-h-screen flex items-center justify-center bg-[#fff1e6] dark:bg-[#0e0e0e]">
    <div
      class="w-10 h-10 border-4 border-[#fa8728]/30 border-t-[#fa8728] rounded-full animate-spin"
    ></div>
  </div>
}

@if (!isLoading) {
  <div class="p-8 space-y-8 min-h-screen bg-transparent transition-colors duration-500">
    <!-- ===== HEADER ===== -->
    <div
      class="flex flex-col md:flex-row md:items-center justify-between gap-6 ci-section"
      style="--delay: 0s"
    >
      <div>
        <h1
          class="text-3xl font-black tracking-tight text-[#444547] dark:text-white"
          style="font-family: 'Alexandria', sans-serif"
        >
          {{ 'CLIENT.PROJECTS.TITLE' | translate }}
        </h1>
        <p
          class="text-sm mt-1 font-medium text-[#5c5f63]/50 dark:text-gray-500"
          style="font-family: 'Alexandria', sans-serif"
        >
          {{ allProjects.length }} {{ 'CLIENT.PROJECTS.ASSIGNED' | translate }}
        </p>
      </div>

      <!-- Filter Tabs -->
      <div
        class="flex p-1 rounded-xl border transition-all bg-white border-[#e6d5c3] dark:bg-[#1c1c1c] dark:border-[#444547]/30"
      >
        @for (f of ['All', 'active', 'pending', 'completed']; track f) {
          <button
            (click)="setFilter(f)"
            class="px-4 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all duration-300 border-none cursor-pointer"
            [class.bg-[#fa8728]]="currentFilter === f"
            [class.text-white]="currentFilter === f"
            [class.text-[#5c5f63]/50]="currentFilter !== f"
            [class.dark:text-gray-500]="currentFilter !== f"
          >
            {{
              f === 'All' ? ('COMMON.ALL' | translate) : ('STATUS.' + f.toUpperCase() | translate)
            }}
          </button>
        }
      </div>
    </div>

    <!-- ===== GRID ===== -->
    <div
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 ci-section"
      style="--delay: 0.06s"
    >
      @for (project of filteredProjects; track project._id) {
        <div
          class="ci-card group relative rounded-3xl border flex flex-col shadow-sm overflow-hidden bg-white border-[#e6d5c3] dark:bg-[#1c1c1c] dark:border-[#444547]/30"
        >
          <!-- Image -->
          <div class="w-full h-44 bg-[#e6d5c3]/30 dark:bg-[#444547]/20 overflow-hidden relative">
            @if (project.photo) {
              <img
                [src]="getPhotoUrl(project.photo)"
                [alt]="project.name"
                class="ci-card-img w-full h-full object-cover"
                (error)="$any($event.target).style.display = 'none'"
              />
            } @else {
              <div class="w-full h-full flex items-center justify-center">
                <span class="text-5xl opacity-10">üèóÔ∏è</span>
              </div>
            }
            <!-- Status -->
            <div
              class="absolute top-4 right-4 flex items-center gap-2 px-3 py-1 rounded-xl backdrop-blur-sm bg-black/30"
            >
              <div
                class="w-1.5 h-1.5 rounded-full"
                [class.bg-[#fa8728]]="project.status === 'active'"
                [class.bg-[#68ab1f]]="project.status === 'completed'"
                [class.bg-white/50]="project.status === 'pending' || !project.status"
              ></div>
              <span class="text-[9px] font-black uppercase tracking-widest text-white">
                {{ 'STATUS.' + (project.status?.toUpperCase() || 'PENDING') | translate }}
              </span>
            </div>
          </div>

          <!-- Body -->
          <div class="p-6 flex flex-col flex-1">
            <h2
              class="text-xl font-black tracking-tight mb-1 truncate transition-colors duration-300 text-[#444547] dark:text-white group-hover:text-[#fa8728]"
              style="font-family: 'Alexandria', sans-serif"
            >
              {{ project.name }}
            </h2>
            @if (project.description) {
              <p
                class="text-xs text-[#5c5f63]/50 dark:text-gray-500 mb-4 line-clamp-2"
                style="font-family: 'Alexandria', sans-serif"
              >
                {{ project.description }}
              </p>
            }

            <!-- Progress -->
            <div class="mt-auto space-y-3">
              <div class="flex justify-between items-end">
                <span
                  class="text-[10px] font-black uppercase tracking-widest text-[#5c5f63]/40 dark:text-gray-600"
                >
                  {{ 'CLIENT.PROJECTS.COMPLETION' | translate }}
                </span>
                <span
                  class="text-sm font-black text-[#444547] dark:text-white"
                  style="font-family: 'Alexandria', sans-serif"
                  >{{ getOutputsProgress(project) }}%</span
                >
              </div>
              <div
                class="h-1.5 w-full rounded-full overflow-hidden bg-[#e6d5c3]/60 dark:bg-[#444547]/20"
              >
                <div
                  class="h-full rounded-full transition-all duration-1000"
                  [class.bg-[#68ab1f]]="getOutputsProgress(project) === 100"
                  [class.bg-[#fa8728]]="getOutputsProgress(project) < 100"
                  [style.width.%]="getOutputsProgress(project)"
                ></div>
              </div>

              <!-- Output tags -->
              @if (project.outputs?.length > 0) {
                <div class="flex flex-wrap gap-1.5 pt-1">
                  @for (output of project.outputs.slice(0, 3); track output._id) {
                    <span
                      class="text-[9px] font-bold px-2 py-1 rounded-lg truncate max-w-[120px] bg-[#fff1e6] border border-[#e6d5c3] text-[#5c5f63]/60 dark:bg-[#444547]/20 dark:border-[#444547]/30 dark:text-gray-500"
                    >
                      {{ output.name }}
                    </span>
                  }
                  @if (project.outputs.length > 3) {
                    <span
                      class="text-[9px] font-bold px-2 py-1 rounded-lg bg-[#fa8728]/10 text-[#fa8728]"
                    >
                      +{{ project.outputs.length - 3 }}
                    </span>
                  }
                </div>
              }
            </div>

            <button
              (click)="openDetails(project._id)"
              class="ci-explore-btn mt-5 w-full py-3.5 rounded-2xl text-[9px] font-black uppercase tracking-widest cursor-pointer border-none bg-[#e6d5c3]/40 dark:bg-[#444547]/20 text-[#5c5f63]/50 dark:text-gray-600"
            >
              {{ 'CLIENT.PROJECTS.CONSOLE' | translate }} ‚Üí
            </button>
          </div>
        </div>
      } @empty {
        <div
          class="col-span-full py-24 flex flex-col items-center justify-center border-2 border-dashed rounded-3xl border-[#e6d5c3] dark:border-[#444547]/30"
        >
          <div class="text-4xl mb-3 opacity-20">üìÇ</div>
          <p
            class="text-[10px] font-black uppercase tracking-widest text-[#5c5f63]/30 dark:text-gray-700"
          >
            {{ 'COMMON.NO_DATA' | translate }}
          </p>
        </div>
      }
    </div>
  </div>
}
